<!DOCTYPE html>
<!-- saved from url=(0045)file:///C:/Users/zweli/Downloads/index_4.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>KA-DAH Prototype v2</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            color: #333;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #app-surface {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #pulse-circle {
            width: 100px;
            height: 100px;
            background-color: #FF8C00;
            border-radius: 50%;
            opacity: 0.8;
            animation: pulse 3s infinite ease-in-out;
            pointer-events: none;
        }

        #pulse-circle.listening {
            background-color: #00CED1;
            animation: pulse-fast 0.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.15); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        @keyframes pulse-fast {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.3); opacity: 0.6; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        #debug-info {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            pointer-events: none;
            text-align: center;
        }

        #visual-state {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.15);
            font-weight: bold;
            margin-top: 20px;
        }

        #gesture-feedback {
            position: absolute;
            bottom: 80px;
            font-size: 1.2rem;
            color: rgba(0, 255, 0, 0.4);
            transition: opacity 0.5s;
            opacity: 0;
        }

        #gesture-feedback.active {
            opacity: 1;
        }

        #voice-result {
            position: absolute;
            bottom: 40px;
            font-size: 1rem;
            color: rgba(255, 200, 0, 0.5);
            max-width: 80%;
            text-align: center;
        }

        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        #start-overlay h1 {
            color: #FF8C00;
            margin-bottom: 10px;
        }

        #start-overlay p {
            color: #888;
            margin: 5px 0;
        }

        .warning {
            background: #331100;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9rem;
            color: #ffaa00;
        }

        button {
            padding: 20px 40px;
            font-size: 1.2rem;
            background: #FF8C00;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            cursor: pointer;
        }

        button:active {
            background: #cc7000;
        }
    </style>
</head>

<body>

    <div id="start-overlay">
        <h1>KA-DAH</h1>
        <p>The Invisible App - Prototype v2</p>
        <div class="warning">
            <strong>⚠️ Best on Chrome (Android or Desktop)</strong><br>
            Voice recognition requires Chrome browser.<br>
            Tap Start, then <strong>Allow</strong> microphone access.
        </div>
        <p>Gestures: Tap | Swipe Right (Next) | Swipe Left (Back) | Long Press (Select) | Two-Finger Down (Home)</p>
        <button id="btn-start">Tap to Start</button>
    </div>

    <div id="app-surface">
        <div id="debug-info">
            <p><strong>KA-DAH v2</strong></p>
            <p>Tap: Identify | Swipe Right: Next | Swipe Left: Back | Long Press: Select | Two-Finger Down: Home</p>
            <p id="current-voice">Voice: Loading...</p>
        </div>

        <div id="pulse-circle"></div>
        <div id="visual-state">Ready</div>
        <div id="gesture-feedback"></div>
        <div id="voice-result"></div>
    </div>

    <script>
        /**
         * KA-DAH PROTOTYPE v2
         * 
         * Features:
         * - Real Voice Recognition (Chrome)
         * - Location Audio Feedback (1/2/3 dings)
         * - App Library Setup with voice input
         * - Uber Journey Simulation
         * - BBC Reading Journey
         */

        // ============================================
        // 1. AUDIO ENGINE
        // ============================================
        const AudioEngine = {
            synth: window.speechSynthesis,
            voice: null,
            queue: [],
            onQueueEmpty: null,
            audioCtx: null,

            init: function() {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.loadVoice();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = this.loadVoice.bind(this);
                }
            },

            loadVoice: function() {
                const voices = this.synth.getVoices();
                let target = voices.find(v => v.lang === 'en-ZA');
                if (!target) target = voices.find(v => v.name.includes('Google') && v.lang.startsWith('en'));
                if (!target) target = voices.find(v => v.lang.startsWith('en'));
                this.voice = target || voices[0];
                if (this.voice) {
                    document.getElementById('current-voice').innerText = `Voice: ${this.voice.name}`;
                }
            },

            speak: function(text, onComplete = null) {
                this.synth.cancel();
                this.queue = [];

                const chunks = text.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [text];
                chunks.forEach(chunk => {
                    const trimmed = chunk.trim();
                    if (trimmed) this.queue.push(trimmed);
                });

                this.onQueueEmpty = onComplete;
                if (!this.synth.speaking) {
                    this.processQueue();
                }
            },

            processQueue: function() {
                if (this.queue.length === 0) {
                    if (this.onQueueEmpty) {
                        const cb = this.onQueueEmpty;
                        this.onQueueEmpty = null;
                        cb();
                    }
                    return;
                }

                const text = this.queue.shift();
                const utterance = new SpeechSynthesisUtterance(text);
                if (this.voice) utterance.voice = this.voice;
                utterance.rate = 0.95;

                utterance.onend = () => this.processQueue();
                utterance.onerror = (e) => console.log("TTS Error", e);

                this.synth.speak(utterance);
                console.log("Speaking:", text);
            },

            stop: function() {
                this.synth.cancel();
                this.queue = [];
                this.onQueueEmpty = null;
            },

            // Play location dings: 1 for Home, 2 for App Library, 3 for Web
            playLocationDing: function(count) {
                let delay = 0;
                for (let i = 0; i < count; i++) {
                    setTimeout(() => this.playTone('ding'), delay);
                    delay += 200;
                }
            },

            playTone: function(type) {
                const ctx = this.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                const now = ctx.currentTime;

                if (type === 'click') {
                    osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.08, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'ding') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                    osc.start(now);
                    osc.stop(now + 0.15);
                } else if (type === 'thud') {
                    osc.frequency.setValueAtTime(200, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'confirm') {
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                } else if (type === 'listen') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.linearRampToValueAtTime(880, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0.15, now + 0.3);
                    gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523, now);
                    osc.frequency.setValueAtTime(659, now + 0.15);
                    osc.frequency.setValueAtTime(784, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.setValueAtTime(0.1, now + 0.4);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else if (type === 'car') {
                    // Car horn sound for Uber arrival
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(350, now);
                    gain.gain.setValueAtTime(0.08, now);
                    gain.gain.setValueAtTime(0.08, now + 0.3);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                }
            }
        };


        // ============================================
        // 2. VOICE RECOGNITION ENGINE
        // ============================================
        const VoiceRecognition = {
            recognition: null,
            isListening: false,
            onResult: null,

            init: function() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn("Speech Recognition not supported");
                    return false;
                }

                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-US';

                this.recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript;
                    console.log("Voice heard:", result);
                    document.getElementById('voice-result').innerText = `Heard: "${result}"`;
                    document.getElementById('pulse-circle').classList.remove('listening');
                    this.isListening = false;
                    if (this.onResult) {
                        this.onResult(result);
                    }
                };

                this.recognition.onerror = (event) => {
                    console.log("Voice error:", event.error);
                    document.getElementById('pulse-circle').classList.remove('listening');
                    this.isListening = false;
                    if (this.onResult) {
                        this.onResult(null);
                    }
                };

                this.recognition.onend = () => {
                    document.getElementById('pulse-circle').classList.remove('listening');
                    this.isListening = false;
                };

                return true;
            },

            listen: function(callback) {
                if (!this.recognition) {
                    console.warn("Voice recognition not available");
                    // Fallback: simulate with prompt
                    const input = prompt("Voice not available. Type your response:");
                    callback(input);
                    return;
                }

                this.onResult = callback;
                this.isListening = true;
                document.getElementById('pulse-circle').classList.add('listening');

                try {
                    this.recognition.start();
                } catch (e) {
                    console.log("Recognition already started");
                }
            },

            stop: function() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }
        };


        // ============================================
        // 3. GESTURE ENGINE
        // ============================================
        const GestureEngine = {
            surface: null,
            startX: 0,
            startY: 0,
            startTime: 0,
            isLongPress: false,
            longPressTimer: null,
            tapCount: 0,
            tapTimer: null,
            touchCount: 0, // Track number of fingers

            LONG_PRESS_MS: 600,
            SWIPE_THRESHOLD: 50,
            DOUBLE_TAP_DELAY: 300,

            init: function(onGesture) {
                this.surface = document.getElementById('app-surface');
                this.onGesture = onGesture;

                this.surface.addEventListener('touchstart', this.handleStart.bind(this), { passive: false });
                this.surface.addEventListener('touchend', this.handleEnd.bind(this), { passive: false });
                this.surface.addEventListener('mousedown', this.handleStart.bind(this));
                this.surface.addEventListener('mouseup', this.handleEnd.bind(this));
            },

            handleStart: function(e) {
                e.preventDefault();
                
                // Track number of fingers
                this.touchCount = e.touches ? e.touches.length : 1;
                
                const point = e.touches ? e.touches[0] : e;
                this.startX = point.clientX;
                this.startY = point.clientY;
                this.startTime = Date.now();
                this.isLongPress = false;

                // Only allow long press with single finger
                if (this.touchCount === 1) {
                    this.longPressTimer = setTimeout(() => {
                        this.isLongPress = true;
                        AudioEngine.playTone('confirm');
                        this.showFeedback("Long Press ✓");
                        this.onGesture('LONG_PRESS');
                    }, this.LONG_PRESS_MS);
                } else {
                    clearTimeout(this.longPressTimer);
                }
            },

            handleEnd: function(e) {
                e.preventDefault();
                clearTimeout(this.longPressTimer);

                if (this.isLongPress) return;

                const point = e.changedTouches ? e.changedTouches[0] : e;
                const endX = point.clientX;
                const endY = point.clientY;
                const diffX = endX - this.startX;
                const diffY = endY - this.startY;

                // Check for swipe
                if (Math.abs(diffX) > this.SWIPE_THRESHOLD || Math.abs(diffY) > this.SWIPE_THRESHOLD) {
                    this.tapCount = 0;
                    clearTimeout(this.tapTimer);

                    // Two-finger swipe down = HOME
                    if (this.touchCount >= 2 && diffY > this.SWIPE_THRESHOLD && Math.abs(diffY) > Math.abs(diffX)) {
                        AudioEngine.playTone('thud');
                        this.showFeedback("↓↓ Two-Finger Swipe Down (HOME)");
                        this.onGesture('TWO_FINGER_SWIPE_DOWN');
                        return;
                    }

                    // Single finger swipes
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        // Horizontal swipe
                        if (diffX > 0) {
                            // Swipe left to right = NEXT
                            AudioEngine.playTone('click');
                            this.showFeedback("→ Swipe Right (Next)");
                            this.onGesture('SWIPE_RIGHT');
                        } else {
                            // Swipe right to left = BACK
                            AudioEngine.playTone('click');
                            this.showFeedback("← Swipe Left (Back)");
                            this.onGesture('SWIPE_LEFT');
                        }
                    }
                    // Single finger vertical swipes (not used for navigation currently)
                } else {
                    // It's a tap
                    this.tapCount++;

                    if (this.tapCount === 1) {
                        this.tapTimer = setTimeout(() => {
                            AudioEngine.playTone('click');
                            this.showFeedback("Tap");
                            this.onGesture('TAP');
                            this.tapCount = 0;
                        }, this.DOUBLE_TAP_DELAY);
                    } else if (this.tapCount === 2) {
                        clearTimeout(this.tapTimer);
                        AudioEngine.playTone('click');
                        this.showFeedback("Double Tap");
                        this.onGesture('DOUBLE_TAP');
                        this.tapCount = 0;
                    }
                }
            },

            showFeedback: function(text) {
                const el = document.getElementById('gesture-feedback');
                el.innerText = text;
                el.classList.add('active');
                setTimeout(() => el.classList.remove('active'), 600);
            }
        };


        // ============================================
        // 4. APP DATA
        // ============================================
        const AppData = {
            userName: "",
            
            categories: [
                { id: 'communication', name: 'Communication', description: 'Apps for calls, messages, and staying in touch. Like Phone, WhatsApp, or Messages.', app: null },
                { id: 'transport', name: 'Transport', description: 'Apps for getting around. Like Uber, Bolt, or Maps.', app: null },
                { id: 'finance', name: 'Finance', description: 'Apps for banking and payments. Like your bank app, or payment services.', app: null },
                { id: 'utilities', name: 'Utilities', description: 'Useful tools like Settings, Calculator, or Weather.', app: null }
            ],

            webSources: [],

            // Mock BBC Articles
            bbcArticles: [
                {
                    headline: "South Africa's Renewable Energy Push Gains Momentum",
                    summary: "The government announces new solar and wind projects across three provinces, aiming to reduce load shedding by 2026.",
                    content: [
                        "South Africa has unveiled ambitious plans to expand its renewable energy capacity, with new solar and wind farms planned across Gauteng, Western Cape, and KwaZulu-Natal.",
                        "Energy Minister announced that these projects could generate up to 5 gigawatts of clean power within the next three years.",
                        "The initiative comes as the country continues to battle frequent power outages, with Eskom struggling to meet demand.",
                        "Private sector investment is expected to play a major role, with several international companies expressing interest.",
                        "Environmental groups have welcomed the move, calling it a crucial step toward meeting climate commitments."
                    ]
                },
                {
                    headline: "Springboks Prepare for Rugby Championship Defence",
                    summary: "Coach reveals squad changes ahead of the opening match against New Zealand in Cape Town.",
                    content: [
                        "The Springboks have named their squad for the upcoming Rugby Championship, with several changes from the World Cup winning team.",
                        "Coach has brought in three new caps, including a promising young flyhalf from the Sharks.",
                        "The opening match against the All Blacks at Cape Town Stadium is expected to draw a capacity crowd.",
                        "Captain emphasized the team's hunger to defend their championship title.",
                        "New Zealand arrives in South Africa this weekend for their pre-match preparations."
                    ]
                },
                {
                    headline: "Johannesburg Tech Hub Attracts Global Investment",
                    summary: "Silicon Valley firms announce plans to establish African headquarters in Sandton.",
                    content: [
                        "Three major Silicon Valley technology companies have announced plans to establish their African headquarters in Johannesburg's Sandton district.",
                        "The investment is expected to create over 2,000 jobs in software development, data science, and customer support.",
                        "City officials say this positions Johannesburg as Africa's leading tech destination.",
                        "Local universities are partnering with the firms to develop specialized training programs.",
                        "The move follows similar investments in fintech and e-commerce sectors over the past two years."
                    ]
                }
            ],

            // Uber simulation data
            uberSimulation: {
                drivers: [
                    { name: "Sipho", car: "White Toyota Corolla", plate: "CA 123-456", rating: 4.9 },
                    { name: "Thandi", car: "Silver VW Polo", plate: "GP 789-012", rating: 4.8 },
                    { name: "David", car: "Blue Honda Fit", plate: "CA 345-678", rating: 4.7 }
                ],
                destinations: ["Home", "Work", "Sandton City", "OR Tambo Airport"],
                currentRide: null
            }
        };


        // ============================================
        // 5. STATE MACHINE
        // ============================================
        const StateMachine = {
            state: 'WELCOME_1',
            currentIndex: 0,
            categoryIndex: 0,
            articleIndex: 0,
            paragraphIndex: 0,
            homeSelection: 0, // 0 = App Library, 1 = Web Content

            // Track where user is in app library
            appLibraryCategoryIndex: 0,

            start: function() {
                this.enterState('WELCOME_1');
            },

            updateVisual: function(text) {
                document.getElementById('visual-state').innerText = text;
            },

            enterState: function(newState) {
                this.state = newState;
                this.updateVisual(newState);
                console.log("State:", newState);

                // Clear voice result display
                document.getElementById('voice-result').innerText = '';

                switch(newState) {
                    // ========== ONBOARDING ==========
                    case 'WELCOME_1':
                        AudioEngine.speak("Welcome to KA-DAH. I am here to help you use your phone independently. Tap anywhere to continue.");
                        break;

                    case 'WELCOME_2':
                        AudioEngine.speak("Let's get started by getting to know you. Tap anywhere to continue.");
                        break;

                    case 'NAME_REQUEST':
                        AudioEngine.speak("What is your name? When you hear the tone, please say your name.", () => {
                            setTimeout(() => {
                                AudioEngine.playTone('listen');
                                VoiceRecognition.listen((result) => {
                                    if (result) {
                                        AppData.userName = result;
                                        AudioEngine.speak(`I heard ${result}. Is that correct? Tap once for yes, or swipe left for no.`);
                                        this.state = 'NAME_CONFIRM';
                                        this.updateVisual('NAME_CONFIRM');
                                    } else {
                                        AudioEngine.speak("I didn't catch that. Let's try again.", () => {
                                            this.enterState('NAME_REQUEST');
                                        });
                                    }
                                });
                            }, 500);
                        });
                        break;

                    // ========== GESTURE TRAINING ==========
                    case 'TEACH_INTRO':
                        AudioEngine.speak("Now let me teach you how to use KA-DAH. There are five main gestures. Tap anywhere to begin.");
                        break;

                    case 'TEACH_SINGLE':
                        AudioEngine.speak("First is the Single Tap. Tap tells you where you are. Try tapping anywhere now.");
                        break;

                    case 'TEACH_SWIPE_RIGHT':
                        AudioEngine.speak("Next is Swipe Right. Swipe from left to right to move forward. Try swiping right now.");
                        break;

                    case 'TEACH_SWIPE_LEFT':
                        AudioEngine.speak("Perfect. Swipe Left takes you back. Try swiping left now.");
                        break;

                    case 'TEACH_LONG_PRESS':
                        AudioEngine.speak("Well done. Long Press is how you select or confirm. Press and hold the screen now.");
                        break;

                    case 'TEACH_SWIPE_DOWN':
                        AudioEngine.speak("Excellent. Finally, to go Home from anywhere, use two fingers and swipe down. Try it now - put two fingers on the screen and swipe down.");
                        break;

                    case 'TEACH_COMPLETE':
                        AudioEngine.speak("Well done! You have learned all the gestures. Now let me explain how KA-DAH works. Tap to continue.");
                        break;

                    // ========== HOW KADAH WORKS TUTORIAL ==========
                    case 'TUTORIAL_STRUCTURE':
                        AudioEngine.speak("KA-DAH has two main areas. The App Library, where your apps live. And Web Content, where you access websites and news. Tap to continue.");
                        break;

                    case 'TUTORIAL_HOME':
                        AudioEngine.speak("You will always start at Home. From Home, you can go to either the App Library or Web Content. Tap to continue.");
                        break;

                    case 'TUTORIAL_SOUNDS':
                        AudioEngine.speak("KA-DAH uses sounds to tell you where you are. Listen carefully.", () => {
                            setTimeout(() => {
                                AudioEngine.playLocationDing(1);
                                setTimeout(() => {
                                    AudioEngine.speak("One sound means you are at Home.", () => {
                                        setTimeout(() => {
                                            AudioEngine.playLocationDing(2);
                                            setTimeout(() => {
                                                AudioEngine.speak("Two sounds means you are in the App Library.", () => {
                                                    setTimeout(() => {
                                                        AudioEngine.playLocationDing(3);
                                                        setTimeout(() => {
                                                            AudioEngine.speak("Three sounds means you are in Web Content. Tap to continue.");
                                                        }, 600);
                                                    }, 500);
                                                });
                                            }, 600);
                                        }, 500);
                                    });
                                }, 400);
                            }, 500);
                        });
                        break;

                    case 'TUTORIAL_APP_LIBRARY':
                        AudioEngine.speak("The App Library has four categories: Communication, Transport, Finance, and Utilities. You will add one app to each category. Tap to continue.");
                        break;

                    case 'TUTORIAL_WEB':
                        AudioEngine.speak("Web Content lets you follow websites like BBC News. You can listen to headlines and full articles. Tap to continue.");
                        break;

                    case 'TUTORIAL_NAVIGATION':
                        AudioEngine.speak("Remember: Swipe right to go forward. Swipe left to go back. Long press to select. And two fingers swipe down to go Home from anywhere. Tap to continue.");
                        break;

                    case 'TUTORIAL_COMPLETE':
                        AudioEngine.speak("Now let's set up your KA-DAH. First, we will add apps to your App Library. Tap to begin.");
                        break;

                    // ========== APP LIBRARY SETUP ==========
                    case 'SETUP_INTRO':
                        this.categoryIndex = 0;
                        AudioEngine.speak("Let's set up your App Library. There are four categories. For each one, you can add one app by saying its name. You can also skip a category by swiping right. Tap to begin.");
                        break;

                    case 'SETUP_CATEGORY':
                        const cat = AppData.categories[this.categoryIndex];
                        AudioEngine.playLocationDing(2); // 2 dings for app library
                        AudioEngine.speak(`App Library. Category ${this.categoryIndex + 1} of 4: ${cat.name}. ${cat.description} Long press to add an app, or swipe right to skip to the next category.`);
                        break;

                    case 'SETUP_CATEGORY_LISTEN':
                        AudioEngine.speak("Say the name of the app you want to add.", () => {
                            setTimeout(() => {
                                AudioEngine.playTone('listen');
                                VoiceRecognition.listen((result) => {
                                    if (result) {
                                        this.tempAppName = result;
                                        AudioEngine.speak(`I heard ${result}. Is that correct? Tap for yes, swipe left for no.`);
                                        this.state = 'SETUP_CATEGORY_CONFIRM';
                                        this.updateVisual('SETUP_CATEGORY_CONFIRM');
                                    } else {
                                        AudioEngine.speak("I didn't catch that. Long press to try again, or swipe right to skip.", () => {
                                            this.state = 'SETUP_CATEGORY';
                                            this.updateVisual('SETUP_CATEGORY');
                                        });
                                    }
                                });
                            }, 500);
                        });
                        break;

                    case 'SETUP_COMPLETE':
                        AudioEngine.playTone('success');
                        AudioEngine.speak("Excellent! Your App Library is set up. Now let's add your web sources. Tap to continue.");
                        break;

                    // ========== WEB SETUP ==========
                    case 'WEB_SETUP_INTRO':
                        AudioEngine.playLocationDing(3); // 3 dings for web
                        AudioEngine.speak("Web Content. Now let's add websites you want to follow. I'll add BBC News automatically. You can add more by saying their names. Long press to add a website, or tap to finish and go home.");
                        AppData.webSources = ['BBC News'];
                        break;

                    case 'WEB_SETUP_LISTEN':
                        AudioEngine.speak("Say the name of the website you want to add.", () => {
                            setTimeout(() => {
                                AudioEngine.playTone('listen');
                                VoiceRecognition.listen((result) => {
                                    if (result) {
                                        this.tempWebsite = result;
                                        AudioEngine.speak(`I heard ${result}. Is that correct? Tap for yes, swipe left for no.`);
                                        this.state = 'WEB_SETUP_CONFIRM';
                                        this.updateVisual('WEB_SETUP_CONFIRM');
                                    } else {
                                        AudioEngine.speak("I didn't catch that. Long press to try again, or tap to finish.", () => {
                                            this.state = 'WEB_SETUP_INTRO';
                                            this.updateVisual('WEB_SETUP_INTRO');
                                        });
                                    }
                                });
                            }, 500);
                        });
                        break;

                    // ========== HOME STATE ==========
                    case 'HOME':
                        this.homeSelection = 0;
                        AudioEngine.playLocationDing(1); // 1 ding for home
                        setTimeout(() => {
                            AudioEngine.speak("Home. You have two options: App Library and Web Content. Swipe right to switch between them. Long press to select.");
                        }, 300);
                        break;

                    // ========== APP LIBRARY NAVIGATION ==========
                    case 'APP_LIBRARY':
                        this.appLibraryCategoryIndex = 0;
                        AudioEngine.playLocationDing(2);
                        setTimeout(() => {
                            this.announceCurrentCategory();
                        }, 500);
                        break;

                    case 'APP_IN_CATEGORY':
                        const currentCat = AppData.categories[this.appLibraryCategoryIndex];
                        if (currentCat.app) {
                            AudioEngine.speak(`${currentCat.app}. Long press to open. Swipe left to go back to categories.`);
                        }
                        break;

                    // ========== UBER JOURNEY ==========
                    case 'UBER_START':
                        AudioEngine.speak("Uber. Where would you like to go? Long press and say your destination.", () => {
                            this.state = 'UBER_WAIT_DESTINATION';
                            this.updateVisual('UBER_WAIT_DESTINATION');
                        });
                        break;

                    case 'UBER_LISTEN_DESTINATION':
                        AudioEngine.speak("Say your destination.", () => {
                            setTimeout(() => {
                                AudioEngine.playTone('listen');
                                VoiceRecognition.listen((result) => {
                                    if (result) {
                                        AppData.uberSimulation.currentRide = {
                                            destination: result,
                                            driver: AppData.uberSimulation.drivers[Math.floor(Math.random() * AppData.uberSimulation.drivers.length)]
                                        };
                                        AudioEngine.speak(`Going to ${result}. Is that correct? Tap for yes, swipe left for no.`);
                                        this.state = 'UBER_CONFIRM_DESTINATION';
                                        this.updateVisual('UBER_CONFIRM_DESTINATION');
                                    } else {
                                        AudioEngine.speak("I didn't catch that. Long press to try again.");
                                        this.state = 'UBER_WAIT_DESTINATION';
                                        this.updateVisual('UBER_WAIT_DESTINATION');
                                    }
                                });
                            }, 500);
                        });
                        break;

                    case 'UBER_SEARCHING':
                        AudioEngine.speak("Searching for a driver nearby.", () => {
                            setTimeout(() => {
                                this.enterState('UBER_DRIVER_FOUND');
                            }, 3000);
                        });
                        break;

                    case 'UBER_DRIVER_FOUND':
                        const driver = AppData.uberSimulation.currentRide.driver;
                        AudioEngine.playTone('success');
                        AudioEngine.speak(`Driver found! ${driver.name} is on the way in a ${driver.car}. License plate ${driver.plate}. Rating ${driver.rating} stars. Tap to hear this again. Long press when you're ready to start the ride.`);
                        break;

                    case 'UBER_EN_ROUTE':
                        AudioEngine.speak("You're on your way! I'll let you know when you're close.", () => {
                            setTimeout(() => {
                                AudioEngine.speak("You're 5 minutes away from your destination.");
                            }, 4000);
                            setTimeout(() => {
                                AudioEngine.speak("You're 2 minutes away.");
                            }, 8000);
                            setTimeout(() => {
                                this.enterState('UBER_ARRIVED');
                            }, 12000);
                        });
                        break;

                    case 'UBER_ARRIVED':
                        AudioEngine.playTone('car');
                        setTimeout(() => {
                            const dest = AppData.uberSimulation.currentRide.destination;
                            AudioEngine.speak(`You have arrived at ${dest}. Thank you for riding with Uber. Tap to go home.`);
                        }, 500);
                        break;

                    // ========== BBC / WEB CONTENT ==========
                    case 'WEB_CONTENT':
                        this.currentIndex = 0;
                        AudioEngine.playLocationDing(3);
                        setTimeout(() => {
                            const sources = AppData.webSources;
                            AudioEngine.speak(`Web Content. You have ${sources.length} sources. First: ${sources[0]}. Swipe right for next, long press to open.`);
                        }, 600);
                        break;

                    case 'BBC_HEADLINES':
                        this.articleIndex = 0;
                        AudioEngine.speak(`BBC News. ${AppData.bbcArticles.length} stories today. First headline: ${AppData.bbcArticles[0].headline}. Swipe right for next headline, long press to read this story.`);
                        break;

                    case 'BBC_ARTICLE':
                        this.paragraphIndex = 0;
                        const article = AppData.bbcArticles[this.articleIndex];
                        AudioEngine.speak(`${article.headline}. ${article.content[0]}`, () => {
                            AudioEngine.speak("Swipe right for next paragraph. Swipe left to go back to headlines.");
                        });
                        break;

                    default:
                        console.log("Unknown state:", newState);
                }
            },

            announceCurrentCategory: function() {
                const cat = AppData.categories[this.appLibraryCategoryIndex];
                const hasApp = cat.app ? `Contains: ${cat.app}.` : 'Empty.';
                AudioEngine.speak(`${cat.name}. Category ${this.appLibraryCategoryIndex + 1} of 4. ${hasApp} Swipe right for next category. Long press to enter.`);
            },

            handleInput: function(gesture) {
                // Global: Two-Finger Swipe Down = Home (except during specific tutorial states)
                if (gesture === 'TWO_FINGER_SWIPE_DOWN' && !this.state.startsWith('TEACH_') && this.state !== 'UBER_EN_ROUTE') {
                    AudioEngine.stop();
                    this.enterState('HOME');
                    return;
                }

                // Don't interrupt tutorial positive reinforcement
                const isTutorial = this.state.startsWith('TEACH_') || this.state.startsWith('NAME_') || this.state.startsWith('SETUP_');
                if (!isTutorial) AudioEngine.stop();

                switch(this.state) {
                    // ========== ONBOARDING ==========
                    case 'WELCOME_1':
                        if (gesture === 'TAP') this.enterState('WELCOME_2');
                        break;

                    case 'WELCOME_2':
                        if (gesture === 'TAP') this.enterState('NAME_REQUEST');
                        break;

                    case 'NAME_CONFIRM':
                        if (gesture === 'TAP') {
                            AudioEngine.speak(`Wonderful to meet you, ${AppData.userName}.`, () => {
                                this.enterState('TEACH_INTRO');
                            });
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.speak("No problem. Let's try again.", () => {
                                this.enterState('NAME_REQUEST');
                            });
                        }
                        break;

                    // ========== GESTURE TRAINING ==========
                    case 'TEACH_INTRO':
                        if (gesture === 'TAP') this.enterState('TEACH_SINGLE');
                        break;

                    case 'TEACH_SINGLE':
                        if (gesture === 'TAP') {
                            AudioEngine.speak("Good.", () => this.enterState('TEACH_SWIPE_RIGHT'));
                        }
                        break;

                    case 'TEACH_SWIPE_RIGHT':
                        if (gesture === 'SWIPE_RIGHT') {
                            AudioEngine.speak("Good.", () => this.enterState('TEACH_SWIPE_LEFT'));
                        }
                        break;

                    case 'TEACH_SWIPE_LEFT':
                        if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.speak("Good.", () => this.enterState('TEACH_LONG_PRESS'));
                        }
                        break;

                    case 'TEACH_LONG_PRESS':
                        if (gesture === 'LONG_PRESS') {
                            AudioEngine.speak("Good.", () => this.enterState('TEACH_SWIPE_DOWN'));
                        }
                        break;

                    case 'TEACH_SWIPE_DOWN':
                        if (gesture === 'TWO_FINGER_SWIPE_DOWN') {
                            AudioEngine.playTone('thud');
                            AudioEngine.speak("Good.", () => this.enterState('TEACH_COMPLETE'));
                        }
                        break;

                    case 'TEACH_COMPLETE':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_STRUCTURE');
                        break;

                    // ========== HOW KADAH WORKS TUTORIAL ==========
                    case 'TUTORIAL_STRUCTURE':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_HOME');
                        break;

                    case 'TUTORIAL_HOME':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_SOUNDS');
                        break;

                    case 'TUTORIAL_SOUNDS':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_APP_LIBRARY');
                        break;

                    case 'TUTORIAL_APP_LIBRARY':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_WEB');
                        break;

                    case 'TUTORIAL_WEB':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_NAVIGATION');
                        break;

                    case 'TUTORIAL_NAVIGATION':
                        if (gesture === 'TAP') this.enterState('TUTORIAL_COMPLETE');
                        break;

                    case 'TUTORIAL_COMPLETE':
                        if (gesture === 'TAP') this.enterState('SETUP_INTRO');
                        break;

                    // ========== APP LIBRARY SETUP ==========
                    case 'SETUP_INTRO':
                        if (gesture === 'TAP') this.enterState('SETUP_CATEGORY');
                        break;

                    case 'SETUP_CATEGORY':
                        if (gesture === 'LONG_PRESS') {
                            this.enterState('SETUP_CATEGORY_LISTEN');
                        } else if (gesture === 'SWIPE_RIGHT' || gesture === 'DOUBLE_TAP') {
                            // Skip this category
                            this.categoryIndex++;
                            if (this.categoryIndex < AppData.categories.length) {
                                AudioEngine.speak("Skipped.", () => this.enterState('SETUP_CATEGORY'));
                            } else {
                                this.enterState('SETUP_COMPLETE');
                            }
                        } else if (gesture === 'TAP') {
                            // Repeat current category info
                            const cat = AppData.categories[this.categoryIndex];
                            AudioEngine.speak(`${cat.name}. Long press to add an app, swipe right to skip.`);
                        }
                        break;

                    case 'SETUP_CATEGORY_CONFIRM':
                        if (gesture === 'TAP') {
                            // Confirmed
                            const cat = AppData.categories[this.categoryIndex];
                            cat.app = this.tempAppName;
                            AudioEngine.speak(`${this.tempAppName} added to ${cat.name}.`, () => {
                                this.categoryIndex++;
                                if (this.categoryIndex < AppData.categories.length) {
                                    this.enterState('SETUP_CATEGORY');
                                } else {
                                    this.enterState('SETUP_COMPLETE');
                                }
                            });
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.speak("Let's try again.", () => {
                                this.enterState('SETUP_CATEGORY_LISTEN');
                            });
                        }
                        break;

                    case 'SETUP_COMPLETE':
                        if (gesture === 'TAP') this.enterState('WEB_SETUP_INTRO');
                        break;

                    // ========== WEB SETUP ==========
                    case 'WEB_SETUP_INTRO':
                        if (gesture === 'LONG_PRESS') {
                            this.enterState('WEB_SETUP_LISTEN');
                        } else if (gesture === 'TAP') {
                            AudioEngine.speak(`Your web sources: ${AppData.webSources.join(', ')}. Going home.`, () => {
                                this.enterState('HOME');
                            });
                        }
                        break;

                    case 'WEB_SETUP_CONFIRM':
                        if (gesture === 'TAP') {
                            AppData.webSources.push(this.tempWebsite);
                            AudioEngine.speak(`${this.tempWebsite} added. Long press to add another, or tap to finish.`, () => {
                                this.state = 'WEB_SETUP_INTRO';
                                this.updateVisual('WEB_SETUP_INTRO');
                            });
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.speak("Let's try again.", () => {
                                this.enterState('WEB_SETUP_LISTEN');
                            });
                        }
                        break;

                    // ========== HOME STATE ==========
                    case 'HOME':
                        if (gesture === 'SWIPE_RIGHT' || gesture === 'DOUBLE_TAP') {
                            this.homeSelection = (this.homeSelection + 1) % 2;
                            AudioEngine.speak(this.homeSelection === 0 ? "App Library" : "Web Content");
                        } else if (gesture === 'SWIPE_LEFT') {
                            this.homeSelection = (this.homeSelection + 1) % 2;
                            AudioEngine.speak(this.homeSelection === 0 ? "App Library" : "Web Content");
                        } else if (gesture === 'LONG_PRESS') {
                            if (this.homeSelection === 0) {
                                this.enterState('APP_LIBRARY');
                            } else {
                                this.enterState('WEB_CONTENT');
                            }
                        } else if (gesture === 'TAP') {
                            AudioEngine.speak(this.homeSelection === 0 ? "App Library" : "Web Content");
                        }
                        break;

                    // ========== APP LIBRARY NAVIGATION ==========
                    case 'APP_LIBRARY':
                        if (gesture === 'SWIPE_RIGHT' || gesture === 'DOUBLE_TAP') {
                            this.appLibraryCategoryIndex = (this.appLibraryCategoryIndex + 1) % AppData.categories.length;
                            this.announceCurrentCategory();
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.playLocationDing(1);
                            AudioEngine.speak("Back to Home.");
                            this.enterState('HOME');
                        } else if (gesture === 'LONG_PRESS') {
                            const cat = AppData.categories[this.appLibraryCategoryIndex];
                            if (cat.app) {
                                // Check if it's Uber
                                if (cat.app.toLowerCase().includes('uber')) {
                                    this.enterState('UBER_START');
                                } else {
                                    this.enterState('APP_IN_CATEGORY');
                                }
                            } else {
                                AudioEngine.speak(`${cat.name} is empty. Long press to add an app.`);
                            }
                        } else if (gesture === 'TAP') {
                            this.announceCurrentCategory();
                        }
                        break;

                    case 'APP_IN_CATEGORY':
                        const catInApp = AppData.categories[this.appLibraryCategoryIndex];
                        if (gesture === 'SWIPE_LEFT') {
                            this.enterState('APP_LIBRARY');
                        } else if (gesture === 'LONG_PRESS') {
                            AudioEngine.speak(`Opening ${catInApp.app}. This is a placeholder.`);
                        } else if (gesture === 'TAP') {
                            AudioEngine.speak(catInApp.app);
                        }
                        break;

                    // ========== UBER JOURNEY ==========
                    case 'UBER_WAIT_DESTINATION':
                        if (gesture === 'LONG_PRESS') {
                            this.enterState('UBER_LISTEN_DESTINATION');
                        } else if (gesture === 'TAP') {
                            AudioEngine.speak("Uber. Long press and say where you want to go.");
                        }
                        break;

                    case 'UBER_CONFIRM_DESTINATION':
                        if (gesture === 'TAP') {
                            this.enterState('UBER_SEARCHING');
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.speak("Let's try again.", () => {
                                this.state = 'UBER_WAIT_DESTINATION';
                                this.updateVisual('UBER_WAIT_DESTINATION');
                                AudioEngine.speak("Long press and say your destination.");
                            });
                        }
                        break;

                    case 'UBER_DRIVER_FOUND':
                        if (gesture === 'TAP') {
                            const d = AppData.uberSimulation.currentRide.driver;
                            AudioEngine.speak(`${d.name} in a ${d.car}. License plate ${d.plate}.`);
                        } else if (gesture === 'LONG_PRESS') {
                            this.enterState('UBER_EN_ROUTE');
                        }
                        break;

                    case 'UBER_ARRIVED':
                        if (gesture === 'TAP') {
                            this.enterState('HOME');
                        }
                        break;

                    // ========== WEB CONTENT ==========
                    case 'WEB_CONTENT':
                        if (gesture === 'SWIPE_RIGHT' || gesture === 'DOUBLE_TAP') {
                            this.currentIndex = (this.currentIndex + 1) % AppData.webSources.length;
                            AudioEngine.speak(AppData.webSources[this.currentIndex]);
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.playLocationDing(1);
                            AudioEngine.speak("Back to Home.");
                            this.enterState('HOME');
                        } else if (gesture === 'LONG_PRESS') {
                            const source = AppData.webSources[this.currentIndex];
                            if (source.toLowerCase().includes('bbc')) {
                                this.enterState('BBC_HEADLINES');
                            } else {
                                AudioEngine.speak(`Opening ${source}. This is a placeholder. Swipe left to go back.`);
                            }
                        } else if (gesture === 'TAP') {
                            AudioEngine.speak(AppData.webSources[this.currentIndex]);
                        }
                        break;

                    case 'BBC_HEADLINES':
                        if (gesture === 'SWIPE_RIGHT' || gesture === 'DOUBLE_TAP') {
                            this.articleIndex = (this.articleIndex + 1) % AppData.bbcArticles.length;
                            AudioEngine.speak(AppData.bbcArticles[this.articleIndex].headline);
                        } else if (gesture === 'SWIPE_LEFT') {
                            AudioEngine.playLocationDing(3);
                            AudioEngine.speak("Back to Web Content.");
                            this.enterState('WEB_CONTENT');
                        } else if (gesture === 'LONG_PRESS') {
                            this.enterState('BBC_ARTICLE');
                        } else if (gesture === 'TAP') {
                            const art = AppData.bbcArticles[this.articleIndex];
                            AudioEngine.speak(`${art.headline}. ${art.summary}`);
                        }
                        break;

                    case 'BBC_ARTICLE':
                        const currentArticle = AppData.bbcArticles[this.articleIndex];
                        if (gesture === 'SWIPE_RIGHT' || gesture === 'DOUBLE_TAP') {
                            this.paragraphIndex++;
                            if (this.paragraphIndex < currentArticle.content.length) {
                                AudioEngine.speak(currentArticle.content[this.paragraphIndex]);
                            } else {
                                AudioEngine.speak("End of article. Swipe left to go back to headlines.");
                            }
                        } else if (gesture === 'SWIPE_LEFT') {
                            this.enterState('BBC_HEADLINES');
                        } else if (gesture === 'TAP') {
                            if (this.paragraphIndex < currentArticle.content.length) {
                                AudioEngine.speak(currentArticle.content[this.paragraphIndex]);
                            } else {
                                AudioEngine.speak("End of article.");
                            }
                        }
                        break;

                    default:
                        console.log("Unhandled state:", this.state);
                }
            }
        };


        // ============================================
        // INITIALIZATION
        // ============================================
        document.getElementById('btn-start').addEventListener('click', async function() {
            document.getElementById('start-overlay').style.display = 'none';

            // Initialize audio engine first
            AudioEngine.init();
            AudioEngine.playTone('click');
            
            // Request microphone permission EARLY (before journey starts)
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("Microphone permission granted");
            } catch (err) {
                console.warn("Microphone permission denied or unavailable:", err);
            }

            // Now initialize voice recognition (permission already granted)
            const voiceSupported = VoiceRecognition.init();
            if (!voiceSupported) {
                console.warn("Voice recognition not supported - will use prompts as fallback");
            }

            GestureEngine.init((g) => StateMachine.handleInput(g));

            // Start the app
            StateMachine.start();
        });
    </script>



</body></html>